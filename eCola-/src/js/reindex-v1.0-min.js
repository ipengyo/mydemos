KISSY.use("sizzle",function(e){var r=e.DOM,p=e.Event;var o="",d=26;var b=null;function u(E,K){var J=r.get(".week-main"),D='<div class="col-time time-line">',L='<div class="col col-{x}" date="{date}">',I="",M=8,F=24*60*60*1000,C=new Date(E).getTime(),N=24;for(var H=0;H<M;H++){if(H==0){for(var G=0;G<N;G++){if(G>=9&&G<18){D+='<span class="time worktime">'+(G<10?"0"+G:G)+':00</span><span class="time worktime odd"></span>'}else{D+='<span class="time">'+(G<10?"0"+G:G)+':00</span><span class="time odd"></span>'}}D+="</div>"}else{I+=L.replace("{x}",H-1).replace("{date}",C+F*(H-1));for(var G=0;G<N;G++){if(G>=9&&G<18){I+='<div class="time worktime"></div><div class="time worktime odd"></div>'}else{I+='<div class="time"></div><div class="time odd"></div>'}}I+="</div>"}}r.html(J,D+I+'<div id="nowTimeLine" class="nowtimeline"></div>');r.scrollTop(J,18*(r.height(e.one(".week-main:eq(0) .time"))+1));K&&K()}function m(C){var D=C<10?"0"+C:C;return D}function q(F,L){var D=e.all(".week-day:eq(0)>li"),K=r.get("#date-from-to"),C=new Date(F),M=7,G=24*60*60*1000,J=new Date(C.getTime()+(M-1)*G),I=["一","二","三","四","五","六","日"];for(var H=0;H<M;H++){var E=new Date(C.getTime()+H*G);r.html(D[H],E.getDate()+" / "+(E.getMonth()+1)+"（"+I[H]+"）")}r.html(K,m(C.getFullYear())+"年"+m(C.getMonth()+1)+"月"+m(C.getDate())+"日 ~ "+m(J.getFullYear())+"年"+m(J.getMonth()+1)+"月"+m(J.getDate())+"日");L&&L()}function c(E){var H=new Date(),G=H.getFullYear()+"/"+(H.getMonth()+1)+"/"+H.getDate(),C=false;for(var D=0;D<7;D++){var F=new Date(new Date(E.replace(/-/g,"/")).valueOf()+D*24*60*60*1000);if(F.getFullYear()+"/"+(F.getMonth()+1)+"/"+F.getDate()==G){C=true}}return C}function B(){var M=r.get("#nowTimeLine");var F=e.one(".week-main");var K=r.height(r.children(F,".time-line")[0]);var C=r.width(r.children(F,".col")[0]);var J=r.width(e.one(".week-main:eq(0) .time-line"));var D=24*60*60*1000;var H=new Date();var L=H.getDay()==0?7:H.getDay();var E=new Date(H.getFullYear()+"/"+m(H.getMonth()+1)+"/"+m(H.getDate()));var I=(H.getTime()-E.getTime())/D;var G=Math.floor(K*I)-1;L-=1;J+=L*r.outerWidth(r.children(F,".col")[0]);r.css(M,"display","block");r.css(M,"left",J);r.css(M,"top",G);r.css(M,"width",C);b=setTimeout(function(){B()},60000)}function g(F,E){var H={};var D=F*0.5*60,C=F+Math.ceil(E/d),G=C*0.5*60;H.d=C-F;H.startH=Math.floor(D/60);H.startH=H.startH<10?"0"+H.startH:H.startH;H.startM=D%60;H.startM=H.startM<10?"0"+H.startM:H.startM;H.endH=Math.floor(G/60);H.endH=H.endH<10?"0"+H.endH:H.endH;H.endM=G%60;H.endM=H.endM<10?"0"+H.endM:H.endM;H.start=[H.startH,H.startM].join(":");H.end=[H.endH,H.endM].join(":");return H}function n(F){var E=e.all(".week-main .col");var D=parseInt(r.attr(E[0],"date"));var F=new Date(F.replace(/-/g,"/")).getTime();var G=24*60*60*1000;var C=(F-D)/G;return{s:D,c:C}}function k(){var F=e.one("#form-layer"),H=e.one(".week-main"),S=e.all(".week-main:eq(0) .fullalpha"),T=[],C=[],Q=[],O=null,U=null,J=false,K=false,V={x:0,y:0},P={x:0,y:0},N={x:0,y:0},L={x:0,y:0},I={x:0,y:0},D={x:0,y:0},M=0,G=0,E=0,R=0;e.each(S,function(W){T.push(r.get("h5",W));C.push(r.get(".log-text",W));Q.push(r.get(".log-resize",W))});p.detach(T,"mousedown");p.detach(Q,"mousedown");p.on(C,"mouseup",function(W){W.halt()});p.on(C,"click",function(){if(e.all(".week-main:eq(0) .text-empty").length>0){r.remove(e.all(".week-main:eq(0) .text-empty"))}j(r.parent(this,".fullalpha"),"update");return false});p.on(T,"mousedown",function(X){if(e.all(".week-main:eq(0) .text-empty").length>0){r.remove(e.all(".week-main:eq(0) .text-empty"))}r.css("#form-layer","display","none");V.x=X.clientX;V.y=X.clientY;P.x=V.x;P.y=V.y;N.x=V.x;N.y=V.y;var W=r.attr(r.parent(this,".fullalpha"),"date-start").split(" ")[1];R=r.attr(r.parent(this,".fullalpha"),"date-start").split(" ")[0];var Y=W.split(":")[0]*60+W.split(":")[1]*1;M=Y/30;G=n(R).c;E=n(R).s;J=true;O=r.parent(this,".fullalpha");X.halt()});p.on(Q,"mousedown",function(X){if(e.all(".week-main:eq(0) .text-empty").length>0){r.remove(e.all(".week-main:eq(0) .text-empty"))}r.css("#form-layer","display","none");L.x=X.clientX;L.y=X.clientY;I.x=L.x;I.y=L.y;D.x=L.x;D.y=L.y;var W=r.attr(r.parent(this,".fullalpha"),"date-start").split(" ")[1];R=r.attr(r.parent(this,".fullalpha"),"date-start").split(" ")[0];var Y=W.split(":")[0]*60+W.split(":")[1]*1;M=Y/30;K=true;U=r.parent(this,".fullalpha");X.halt()});p.on(H,"mousemove",function(ad){if(J){N.x=ad.clientX;N.y=ad.clientY;var X=N.y-P.y;var ac=d;var af=N.x-P.x;var ag=r.width(O)+3;if(Math.abs(X)>d/2){ac=X>0?d:-1*d;r.css(O,"top",parseInt(r.css(O,"top"))+ac);P.y+=ac;M=X>0?M+1:M-1;var Y=g(M,r.height(O));var W=R+" "+Y.start+":00";var ah=R+" "+Y.end+":00";r.html(r.get("h5",O),Y.start+" ~ "+Y.end);r.attr(O,"date-start",W);r.attr(O,"date-end",ah)}if(Math.abs(af)>=ag){ag=af>0?ag:-1*ag;G=af>0?G+1:G-1;if(G<=0){G=0}else{if(G>=6){G=6}}r.css(O,"left",parseInt(r.css(O,"left"))+ag);P.x+=ag;var ab=new Date(parseInt(E)+G*24*60*60*1000);R=ab.getFullYear()+"-"+m(ab.getMonth()+1)+"-"+m(ab.getDate());var aa=g(M,r.height(O));var W=R+" "+aa.start+":00";var ah=R+" "+aa.end+":00";r.html(r.get("h5",O),aa.start+" ~ "+aa.end);r.attr(O,"date-start",W);r.attr(O,"date-end",ah)}}if(K){D.x=ad.clientX;D.y=ad.clientY;var ae=D.y-I.y;var Z=d;if(Math.abs(ae)>d){Z=ae>0?d:-1*d;I.y+=Z;r.css(U,"height",r.height(U)+Z);var Y=g(M,r.height(U));var W=R+" "+Y.start+":00";var ah=R+" "+Y.end+":00";r.html(r.get("h5",U),Y.start+" ~ "+Y.end);r.attr(U,"date-start",W);r.attr(U,"date-end",ah)}}});p.on(document,"mouseup",function(Z){var X=null;if(J){X=O}if(K){X=U}if(J||K){J=false;K=false;var W="worklogs/"+r.attr(X,"id")+".json";var Y="authenticity_token="+r.attr(e.one('meta[name="csrf-token"]'),"content")+"&worklog[id]="+r.attr(X,"id")+"&worklog[content]="+r.html(r.get(".log-text",X))+"&worklog[begin_at]="+r.attr(X,"date-start")+"&worklog[end_at]="+r.attr(X,"date-end")+"&worklog[team_name]="+r.attr(X,"cat")+"&_method=put";e.IO({type:"POST",dataType:"json",url:W,data:Y,success:function(ab){var aa=ab;if(aa.status=="success"){k()}else{alert("日志保存失败了，休息一会儿再来吧！")}}})}})}function j(G,N){var J=e.one("#form-layer"),O=e.one(".week-main"),E=e.one(G),I=parseInt(r.css(E,"left")),D=parseInt(r.css(E,"top")),C=r.outerWidth(E),K=r.outerHeight(E),F=r.outerWidth(J),P=r.outerHeight(J),M=I+C+20,H=D+(K-P)/2-r.scrollTop(O),L=r.attr(E,"cat");r.removeClass(J,"outOfTheWindow");if(M+F>r.width(window)){M-=(F+C+40);r.addClass(J,"outOfTheWindow")}r.css(J,"left",M);r.css(J,"top",H);r.css(J,"display","block");if(L==""||L=="null"){L=0}r.val(r.query("textarea",J)[0],r.html(r.children(E,".log-text")[0]));r.query("textarea",J)[0].focus();r.val(r.query("input[type='hidden']",J)[0],r.attr(E,"id"));r.val(r.query("input[type='hidden']",J)[1],r.attr(E,"date-start"));r.val(r.query("input[type='hidden']",J)[2],r.attr(E,"date-end"));r.attr(e.all("#ecola-cat option[value='"+L+"']"),"selected",true);r.attr(e.one(".ecola-del"),"href","worklogs/"+r.attr(E,"id")+".json");if(N=="add"){r.attr(e.one(".ecola-save"),"href","worklogs.json");r.css(e.one(".ecola-del"),"visibility","hidden")}else{if(N=="update"){r.attr(e.one(".ecola-save"),"href","worklogs/"+r.attr(E,"id")+".json");r.css(e.one(".ecola-del"),"visibility","visible")}}p.detach(e.one(".ecola-save"),"click");p.detach(e.one(".ecola-del"),"click");p.on(e.one(".ecola-save"),"click",function(){var R=r.attr(this,"href");var T={},Q={};T.content=r.val(e.one("textarea"));T.id=r.val(r.query("input[type='hidden']",J)[0]);T.begin_at=r.val(r.query("input[type='hidden']",J)[1]);T.end_at=r.val(r.query("input[type='hidden']",J)[2]);T.team_name=r.val(e.one("#ecola-cat"));Q.worklog=T;Q.authenticity_token=r.attr(e.one('meta[name="csrf-token"]'),"content");if(N=="update"){Q._method="put"}var S="authenticity_token="+Q.authenticity_token+"&worklog[id]="+Q.worklog.id+"&worklog[content]="+Q.worklog.content+"&worklog[begin_at]="+Q.worklog.begin_at+"&worklog[end_at]="+Q.worklog.end_at+"&worklog[team_name]="+Q.worklog.team_name;if(N=="update"){S+="&_method=put"}e.IO({type:"POST",dataType:"json",url:R,data:S,success:function(V){var U=V;if(U.status=="success"){r.html(r.children(E,".log-text")[0],T.content);r.attr(E,"id",U.id);r.attr(E,"cat",U.cat);r.attr(r.children(E,".log-text")[0],"title",T.content);r.removeClass(E,"text-empty");r.addClass(E,"fullalpha");r.css(e.one("#form-layer"),"display","none");o="";k()}else{alert("日志保存失败了，休息一会儿再来吧！")}}});return false});p.on(e.one(".ecola-del"),"click",function(){var R=r.attr(this,"href");var Q=confirm("日志一经删除无法恢复，确定删除该条日志吗？");if(Q){e.IO.post(R,{_method:"delete"},function(T){var S=T;if(S.status=="success"){r.css(e.one("#form-layer"),"display","none");r.remove(E)}else{alert("删除失败了，请稍后重试")}})}return false})}function w(){var K=e.one(".week-main");var M=e.all(".week-main:eq(0)>.col");var G=e.one(".week-main:eq(0)>.col-time"),J={x:1,y:0};var H=false;var F="";var E="";var L="";var D={x:0,y:0};var I={x:0,y:0};var C={x:0,y:0};p.on(M,"mousedown",function(U){E=e.indexOf(this,M);D.x=U.clientX;D.y=U.clientY;I.x=U.clientX;I.y=U.clientY;var P=U.target,O=r.children(this,".time"),Q=e.indexOf(this,M);H=true;F=e.indexOf(P,O);if(o!=""){r.remove(o);r.css(e.one("#form-layer"),"display","none")}var R=r.outerWidth(P),N=d,T=(Q*R+r.width(G)+J.x)+"px",S=(F*N+J.y)+"px";o=r.create('<div class="uplayer text-empty"></div>');r.attr(o,"id","");r.attr(o,"cat","");r.css(o,"left",T);r.css(o,"top",S);r.css(o,"width",R-J.x-2);r.css(o,"height",0);r.append(o,K);return false});p.on(K,"mousemove",function(R){if(H){C.x=R.clientX;C.y=R.clientY;if(C.y-I.y>=d/2){I.y+=d;var T=r.height(o);T=T>0?T:-2;r.css(o,"height",T+d)}else{if(C.y-I.y<=-(d/2)){I.y-=d;var T=r.height(o);if(I.y<=D.y){I.y=D.y;r.css(o,"height",0)}else{r.css(o,"height",T-d)}}}var Q=r.height(o)+2;if(Q>2){var N=g(F,Q);var P=new Date(parseInt(r.attr(M[E],"date")));var O=P.getFullYear()+"-"+m(P.getMonth()+1)+"-"+m(P.getDate())+" "+N.start+":00";var S=P.getFullYear()+"-"+m(P.getMonth()+1)+"-"+m(P.getDate())+" "+N.end+":00";r.attr(o,"date-start",O);r.attr(o,"date-end",S);r.html(o,"<h5>"+[N.start,N.end].join(" ~ ")+"</h5><a href='#' class='log-text' title='"+L+"'>"+L+"</a><span class='log-resize'></span>")}}});p.on(document,"mouseup",function(){if(r.get(o)&&r.height(o)<=0){r.css(o,"height",2*d-2);var N=g(F,r.height(o));var P=new Date(parseInt(r.attr(M[E],"date")));var O=P.getFullYear()+"-"+m(P.getMonth()+1)+"-"+m(P.getDate())+" "+N.start+":00";var Q=P.getFullYear()+"-"+m(P.getMonth()+1)+"-"+m(P.getDate())+" "+N.end+":00";r.attr(o,"date-start",O);r.attr(o,"date-end",Q);r.html(o,"<h5>"+[N.start,N.end].join(" ~ ")+"</h5><a href='#' class='log-text' title='"+L+"'>"+L+"</a><span class='log-resize'></span>")}if(H){j(o,"add")}H=false;return false})}function z(K,C,S,P){var H=e.one(".week-main");var I=e.one(".week-main:eq(0)>.col-time");var D=r.create('<div class="uplayer fullalpha"></div>');var M={x:1,y:0};var O=30*60*1000;var G=r.width(I)+K*parseInt(S.w)+M.x;var R=0;var Q=0,L=0,J=0;var F=C.start.split(":");var N=C.end.split(":");Q=(F[0]*60*60+F[1]*60)*1000;L=(N[0]*60*60+N[1]*60)*1000;J=Math.abs(L/O-Q/O)*S.h;R=(Q/O)*S.h;var E=r.clone(D);r.attr(E,"id",C.id);r.attr(E,"cat",(C.cat&&C.cat!=null)?C.cat:0);r.attr(E,"date-start",C.date.replace(/\//g,"-")+" "+C.start+":00");r.attr(E,"date-end",C.date.replace(/\//g,"-")+" "+C.end+":00");r.css(E,"left",G);r.css(E,"top",R);r.css(E,"width",S.w-M.x-2);r.css(E,"height",J-2);r.html(E,"<h5>"+C.start+" ~ "+C.end+"</h5><a href='#' class='log-text' title='"+C.content+"'>"+C.content+"</a><span class='log-resize'></span>");r.append(E,H);P&&P()}function a(D){var C=e.all(".week-main:eq(0)>.col");e.getScript("worklogs.json?s="+new Date(D.replace(/-/g,"/")).getTime(),function(){if(json.length>0){e.each(json,function(E){e.each(C,function(H){var F=e.indexOf(H,C);if(r.attr(H,"date")==new Date(E.date).getTime()){var G={w:r.width(H),h:d};z(F,E,G,function(){r.css(e.one("#loading"),"display","none");k()})}})})}else{r.css("#loading","display","none")}})}var l=new Date();var A=getThisWeek(l.getFullYear(),l.getMonth()+1,l.getDate());var x=A.weekStart;var i=x.replace(/\//g,"-");var s=null;var f=/(\d{4}-\d{2}-\d{2})/g;var t=r.get("#week-prev"),v=r.get("#week-next"),y=r.get("#today");if(f.test(window.location.href)){i=RegExp.$1;RegExp.lastIndex=0;r.css(r.get("#loading"),"display","block");q(i.replace(/-/g,"/"));u(i.replace(/-/g,"/"),function(){w();if(c(i)){B();addToday();r.attr(y,"disabled",true)}else{clearTimeout(b);removeToday();r.attr(y,"disabled",false)}a(i)})}else{window.location.hash="#"+i}e.all(".week-main").on("selectstart",function(){return false});var h=r.height(window);r.css(r.get(".week-main"),"height",h-220);p.on(window,"resize",function(){h=r.height(window);r.css(r.get(".week-main"),"height",h-220)});e.all(window).on("hashchange",function(){var C=window.location.href;var D=C.match(f);if(D&&D.length>0){i=D[0];if(i!=s){r.css(r.get("#loading"),"display","block");q(i.replace(/-/g,"/"));u(i.replace(/-/g,"/"),function(){w();if(c(i)){B();addToday();r.attr(y,"disabled",true)}else{clearTimeout(b);removeToday();r.attr(y,"disabled",false)}a(i)})}}else{i=x.replace(/\//g,"-");window.location.hash="#"+i}s=D[0]});e.one("#form-layer .ecola-cancel").on("click",function(){var C=r.get("#form-layer");if(o!=""){r.remove(o)}r.css(C,"display","none");return false});p.on(document,"click, mouseup",function(G){var E=r.get(G.target);var F=false;var D=false;var C=r.get(E);while(C.tagName!="BODY"){if(r.hasClass(C,"fullalpha")||r.hasClass(C,"text-empty")||r.hasClass(C,"week-main")){D=true;break}C=r.parent(C)}while(E.tagName!="BODY"&&!D){if(E.id=="form-layer"){F=true;break}E=r.parent(E)}if(!F&&!D){p.fire(e.one("#form-layer .ecola-cancel"),"click")}});p.on(y,"click",function(){i=x.replace(/\//g,"-");window.location.hash="#"+i});p.on(t,"click",function(){var C=new Date(new Date(i.replace(/-/g,"/")).getTime()-7*24*60*60*1000);i=C.getFullYear()+"-"+m(C.getMonth()+1)+"-"+m(C.getDate());window.location.hash="#"+i});p.on(v,"click",function(){var C=new Date(new Date(i.replace(/-/g,"/")).getTime()+7*24*60*60*1000);i=C.getFullYear()+"-"+m(C.getMonth()+1)+"-"+m(C.getDate());window.location.hash="#"+i})});
