<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>KISSY.Blocks</title>
</head>
<body>
<style>
.bc {
	position: relative;
	background-color: #014051;
	width: 350px;
}
.blocks {
	position: absolute;
	height: 80px;
	line-height: 80px;
	font-size: 18px;
	text-align: center;
	color: #fff;
}
</style>
<div class="J_Blocks bc" id="J_Blocks"></div>
<script src="http://a.tbcdn.cn/s/kissy/1.2.0/kissy-min.js"></script>
<script>
KISSY.ready(function(S){
	var D = S.DOM, E = S.Event;
	var count = 12,
		model = [80, 80, 166],
		pa = S.one("#J_Blocks"),
		node = D.create('<div class="blocks"></div>'),
		color = ["#298af3","#5634af","#d44928","#6bb71f","#bc1c48","#1f7982","#010103"];
	
	for(var i = 0; i < count; i++){
		var items = D.clone(node);
		D.css(items, "width", model[Math.floor(Math.random() * model.length)]);
		D.css(items, "backgroundColor", color[Math.floor(Math.random() * color.length)]);
		D.html(items, i);
		D.append(items, pa);
	}
});
</script>
<script>
KISSY.ready(function(S){
	KISSY.add("blocks", function(S){
		var D = S.DOM, E = S.Event;
		function Blocks(cfg){
			this.ct = S.one(cfg.container);
			this.bs = D.query(cfg.blocks, this.ct);
			this.space = cfg.space;
			this.init();
		}
		Blocks.prototype = {
			_row: [0],
			_maxTop: 0,
			setMaxTop: function(){
				var _this = this;
				_this._maxTop = _this.space;
				for(var i = 0; i < _this._row.length; i++){
					_this._row[i] = _this.space;
				}
			},
			minRow: function(arr){
				var mix = arr[0], ai = 0, len = arr.length;
				for(var i = 0; i < len; i++){
					if(mix > arr[i]){
						mix = arr[i];
						ai = i;
					}
				}
				return ai;
			},
			render: function(){
				var _this = this, cw = D.width(_this.ct), len = _this.bs.length;
				for(var i = 0; i < len; i++){
					if(_this._row[_this.minRow(_this._row)] + D.width(_this.bs[i]) + _this.space > cw){
						var olen = _this._row.length;
						_this._row[olen] = _this.space;
						D.css(_this.bs[i], {"left": _this.space, "top": _this._maxTop});
						_this._maxTop += D.height(_this.bs[i]) + _this.space;
						_this._row[olen] += D.width(_this.bs[i]) + _this.space;
					}else{
						var mr = _this.minRow(_this._row),
							mt = mr * 86 + D.height(_this.bs[i]) + 2 * _this.space;
						D.css(_this.bs[i], {"left": _this._row[mr], "top": mr * 86 + _this.space});
						_this._row[mr] += D.width(_this.bs[i]) + _this.space;
						if(mt > _this._maxTop){
							_this._maxTop = mt;
						}
					}
				}
				D.css(_this.ct, "height", _this._maxTop);
			},
			init: function(){
				console.log(this._maxTop);
				var _this = this;
				_this.setMaxTop();
				_this.render();
			}
		}
		S.Blocks = Blocks;
	});
	KISSY.use("blocks", function(S){
		var bs = new S.Blocks({
			container: ".J_Blocks",
			blocks: ".blocks",
			space: 6
		});
	});
});
</script>
</body>
</html>

